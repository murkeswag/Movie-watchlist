<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Movie Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
      };
    </script>
    <style>
      .backdrop-fade {
        position: relative;
        overflow: hidden;
      }
      .backdrop-fade::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 120px;
        background: linear-gradient(
          180deg,
          rgba(244, 244, 244, 0) 0%,
          #f4f4f4 100%
        );
        pointer-events: none;
        z-index: 1;
      }

      .modal-poster {
        position: absolute;
        top: 110px;
        left: 24px;
        width: 140px;
        border-radius: 12px;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.6);
        z-index: 10;
        background: white;
        object-fit: cover;
      }

      /* brokent */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }

      ::-webkit-scrollbar-thumb {
        background-color: rgba(100, 100, 100, 0.4);
        border-radius: 9999px;
        border: 2px solid transparent;
        background-clip: content-box;
      }

      ::-webkit-scrollbar-track {
        background-color: transparent;
      }

      html.dark ::-webkit-scrollbar-thumb {
        background-color: rgba(255, 255, 255, 0.2);
      }

      /* Firefox scrollbars */
      body,
      * {
        scrollbar-width: thin;
        scrollbar-color: rgba(100, 100, 100, 0.4) transparent;
      }

      html.dark body,
      html.dark * {
        scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
      }
    </style>
  </head>
  <body
    class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen flex flex-col items-center p-6"
  >
    <!--Dark Mode Toggle and Settings-->
    <div class="absolute top-4 right-4 flex gap-3">
      <button
        id="darkToggle"
        class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition"
      >
        Toggle Dark Mode
      </button>

      <button
        id="settingsToggle"
        class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded hover:bg-gray-300 dark:hover:bg-gray-600 transition"
      >
        Settings
      </button>
    </div>

    <h1 class="text-4xl font-bold mb-8 text-center">Movie List</h1>

    <form id="movieForm" class="flex w-full max-w-5xl mb-6 space-x-3">
      <input
        type="text"
        id="movieTitle"
        placeholder="Enter movie title"
        required
        class="flex-grow px-4 py-3 rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
      />
      <input
        type="number"
        id="movieYear"
        placeholder="Year (optional)"
        min="1878"
        max="2100"
        class="w-28 px-3 py-3 rounded-md border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-800 text-black dark:text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
      />
      <button
        type="submit"
        class="bg-indigo-600 text-white px-7 rounded-md hover:bg-indigo-700 transition"
      >
        Add Movie
      </button>
    </form>

    <div
      id="errorMsg"
      class="text-red-600 mb-6 text-center min-h-[1.5rem] max-w-5xl"
    ></div>

    <section class="w-full max-w-5xl mb-8 flex flex-col items-center">
      <div class="w-full" style="max-width: fit-content">
        <h2
          class="text-2xl font-semibold mb-4 text-gray-700 dark:text-gray-300"
        >
          Recently Added
        </h2>
        <ul id="recentLibrary" class="flex flex-wrap gap-6"></ul>
      </div>
    </section>

    <div class="sticky top-0 z-10 bg-gray-100 dark:bg-gray-900 py-3 px-4">
      <div class="w-full flex justify-between items-end flex-col sm:flex-row gap-3">
        <div class="text-left">
          <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-300">
            Full Library
          </h2>
          <p id="totalRuntime" class="text-base font-medium text-gray-600 dark:text-gray-300 mt-1">
            Total Runtime: Calculating...
          </p>
        </div>
    
        <div class="flex gap-2">
          <select
            id="sortSelect"
            class="px-3 py-2 rounded-md border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 text-gray-800 dark:text-white"
          >
            <option value="">Sort by</option>
            <option value="runtime">Runtime</option>
            <option value="rating">IMDb Rating</option>
            <option value="year">Year Released</option>
          </select>
        </div>
      </div>
    </div>
    
    

      <div class="w-full max-h-[70vh] overflow-y-auto relative">
        <ul
          id="library"
          class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 items-start"
        ></ul>
      </div>
    </section>

    <!--Modal for movie details-->
    <div
      id="movieModal"
      class="fixed inset-0 bg-black bg-opacity-70 hidden flex justify-center items-center z-50"
      role="dialog"
      aria-modal="true"
      aria-labelledby="modalTitle"
    >
      <div class="max-h-[90vh] overflow-y-auto p-8 w-full max-w-6xl">
        <div
          class="relative bg-gray-100 dark:bg-gray-800 rounded-t-lg rounded-b-lg overflow-hidden w-full shadow-lg flex flex-col"
        >
          <div
            id="modalBackdrop"
            class="backdrop-fade h-60 bg-gray-300 relative"
          ></div>
          <img id="modalPoster" class="modal-poster hidden" alt="Poster" />

          <div class="absolute left-[180px] top-[260px] z-20 pr-8">
            <h2
              id="modalTitle"
              class="text-4xl font-bold text-black dark:text-white drop-shadow-md"
            ></h2>
            <p
              id="modalInfo"
              class="text-lg text-gray-700 dark:text-gray-300 drop-shadow-sm mt-1"
            ></p>
            <p
              id="modalRating"
              class="text-base text-yellow-600 dark:text-yellow-400 font-semibold mt-1"
            ></p>
          </div>

          <div
            id="modalContent"
            class="modal-content p-8 pt-32 overflow-y-auto flex flex-col gap-6 text-gray-900 dark:text-gray-100"
          >
            <button
              id="modalCloseBtn"
              class="absolute top-4 right-6 text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white text-3xl font-bold cursor-pointer"
              title="Close modal"
              aria-label="Close modal"
            >
              &times;
            </button>
            <p
              id="modalOverview"
              class="mt-2 text-gray-800 dark:text-gray-200 text-base leading-relaxed max-w-3xl"
            ></p>
            <div
              id="modalCredits"
              class="mt-6 flex flex-wrap gap-6 text-gray-700 dark:text-gray-300"
            ></div>
          </div>
        </div>
      </div>
    </div>
    <!-- Settings Modal -->
    <div
      id="settingsModal"
      class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex justify-center items-center"
    >
      <div
        class="bg-white dark:bg-gray-800 p-8 rounded-lg w-full max-w-md shadow-xl relative"
      >
        <button
          id="closeSettings"
          class="absolute top-2 right-4 text-2xl text-gray-500 dark:text-gray-300 hover:text-black dark:hover:text-white"
          title="Close"
        >
          &times;
        </button>
        <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">
          Settings
        </h2>

        <!-- Export Library -->
        <button
          id="exportBtn"
          class="w-full mb-4 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition"
        >
          Export Library
        </button>

        <!-- Import Library -->
        <label
          for="importInput"
          class="w-full block text-center px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 cursor-pointer transition"
        >
          Import Library
          <input id="importInput" type="file" accept=".json" class="hidden" />
        </label>
      </div>
    </div>

    <script>
      async function backfillMissingRuntimes() {
  const updates = await Promise.all(
    savedMovies.map(async (movie) => {
      if (movie.runtime == null) {
        try {
          const res = await fetch(`${apiBase}/movie/${movie.id}?api_key=${apiKey}&language=en-US`);
          const data = await res.json();
          movie.runtime = data.runtime || 0;
          movie.vote_average = data.vote_average || 0;
          movie.release_date = data.release_date || "";
        } catch (err) {
          console.warn(`Could not fetch runtime for ${movie.title}`);
        }
      }
      return movie;
    })
  );
  savedMovies = updates;
  saveMovies();
}


      const darkToggle = document.getElementById("darkToggle");
      const html = document.documentElement;

      function updateDarkToggleText() {
        if (html.classList.contains("dark")) {
          darkToggle.textContent = "Light Mode";
        } else {
          darkToggle.textContent = "Dark Mode";
        }
      }

      if (
        localStorage.getItem("theme") === "dark" ||
        (!localStorage.getItem("theme") &&
          window.matchMedia("(prefers-color-scheme: dark)").matches)
      ) {
        html.classList.add("dark");
      }

      updateDarkToggleText();

      darkToggle.addEventListener("click", () => {
        const isDark = html.classList.toggle("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        updateDarkToggleText();
      });
    </script>

    <script>
      const apiKey = "f36a3d93d80c1f6e3a87128165c365da";
      const apiBase = "https://api.themoviedb.org/3";
      const imageBase = "https://image.tmdb.org/t/p/";

      const form = document.getElementById("movieForm");
      const input = document.getElementById("movieTitle");
      const yearInput = document.getElementById("movieYear");
      const library = document.getElementById("library");
      const recentLibrary = document.getElementById("recentLibrary");
      const errorMsg = document.getElementById("errorMsg");

      const modal = document.getElementById("movieModal");
      const modalBackdrop = document.getElementById("modalBackdrop");
      const modalPoster = document.getElementById("modalPoster");
      const modalTitle = document.getElementById("modalTitle");
      const modalInfo = document.getElementById("modalInfo");
      const modalOverview = document.getElementById("modalOverview");
      const modalCredits = document.getElementById("modalCredits");
      const modalCloseBtn = document.getElementById("modalCloseBtn");

      let savedMovies = JSON.parse(localStorage.getItem("movieLibrary")) || [];
      const RECENT_LIMIT = 5;

      async function renderLibrary() {
  library.innerHTML = "";
  recentLibrary.innerHTML = "";

  await backfillMissingRuntimes();


        const recentMovies = savedMovies.slice(-RECENT_LIMIT).reverse();
        recentMovies.forEach((movie) => {
          const li = createRecentMovieElement(movie);
          recentLibrary.appendChild(li);
        });

        const sortBy = document.getElementById("sortSelect")?.value || "";
const sortedMovies = sortMovies(sortBy);

sortedMovies.forEach((movie) => {
  const li = createMovieElement(movie);
  library.appendChild(li);
});


        function sortMovies(criterion) {
  switch (criterion) {
    case "runtime":
      return [...savedMovies].sort((a, b) => (b.runtime || 0) - (a.runtime || 0));
    case "rating":
      return [...savedMovies].sort((a, b) => (b.vote_average || 0) - (a.vote_average || 0));
    case "year":
      return [...savedMovies].sort((a, b) => {
        const ay = a.release_date ? parseInt(a.release_date.slice(0, 4)) : 0;
        const by = b.release_date ? parseInt(b.release_date.slice(0, 4)) : 0;
        return by - ay;
      });
    default:
      return [...savedMovies];
  }
}


        calculateTotalRuntime();
      }
      async function calculateTotalRuntime() {
        const runtimeElement = document.getElementById("totalRuntime");
        let total = 0;

        for (let movie of savedMovies) {
  if (movie.runtime) total += movie.runtime;
}


        runtimeElement.textContent = `Total Runtime: ${total} minutes (${Math.floor(
          total / 60
        )}h ${total % 60}m)`;
      }

      function createRecentMovieElement(movie) {
        const li = document.createElement("li");
        li.className =
          "w-40 cursor-pointer hover:scale-105 transform transition";

        const img = document.createElement("img");
        img.className = "w-full rounded-md shadow-md";
        img.src = movie.poster_path
          ? imageBase + "w342" + movie.poster_path
          : "https://via.placeholder.com/160x240?text=No+Image";
        img.alt = movie.title + " poster";

        const title = document.createElement("p");
        title.className =
          "mt-3 text-center text-base font-semibold text-gray-900 truncate";
        const year = movie.release_date
          ? ` (${movie.release_date.slice(0, 4)})`
          : "";
        title.textContent = movie.title + year;

        li.appendChild(img);
        li.appendChild(title);
        li.addEventListener("click", () => openMovieModal(movie.id));

        return li;
      }

      function createMovieElement(movie) {
        const li = document.createElement("li");
        li.className =
          "bg-white dark:bg-gray-800 rounded-lg shadow-md flex p-4 relative cursor-pointer hover:shadow-xl transition";

        const poster = document.createElement("img");
        poster.className = "w-28 h-auto rounded-md object-cover flex-shrink-0";
        poster.src = movie.poster_path
          ? imageBase + "w185" + movie.poster_path
          : "https://via.placeholder.com/100x150?text=No+Image";
        poster.alt = movie.title + " poster";

        const info = document.createElement("div");
        info.className = "flex flex-col ml-6 flex-grow";

        const title = document.createElement("h3");
        title.className = "text-xl font-semibold text-gray-900 dark:text-white";
        const year = movie.release_date
          ? ` (${movie.release_date.slice(0, 4)})`
          : "";
        title.textContent = movie.title + year;

        const overview = document.createElement("p");
        overview.className =
          "mt-2 text-gray-700 dark:text-gray-300 text-sm flex-grow overflow-hidden";
        overview.textContent = movie.overview || "No description available.";

        const removeBtn = document.createElement("button");
        removeBtn.className =
          "absolute top-3 right-3 text-gray-1000 hover:text-red-800 dark:hover:text-red-400 font-bold text-lg";
        removeBtn.textContent = "✕";
        removeBtn.title = "Remove movie";
        removeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          removeMovie(movie.id);
        });

        info.appendChild(title);
        info.appendChild(overview);
        li.appendChild(poster);
        li.appendChild(info);
        li.appendChild(removeBtn);

        li.addEventListener("click", () => openMovieModal(movie.id));
        return li;
      }

      function saveMovies() {
        localStorage.setItem("movieLibrary", JSON.stringify(savedMovies));
      }

      function removeMovie(id) {
        savedMovies = savedMovies.filter((m) => m.id !== id);
        saveMovies();
        renderLibrary();
      }

      document.getElementById("sortSelect").addEventListener("change", () => {
  renderLibrary();
});


      async function openMovieModal(movieId) {
        modalBackdrop.style.backgroundImage = "";
        modalPoster.style.display = "none";
        modalTitle.textContent = "";
        modalInfo.textContent = "";
        modalOverview.textContent = "";
        modalCredits.innerHTML = "";
        modal.classList.remove("hidden");

        try {
          const [detailsRes, creditsRes] = await Promise.all([
            fetch(
              `${apiBase}/movie/${movieId}?api_key=${apiKey}&language=en-US`
            ),
            fetch(`${apiBase}/movie/${movieId}/credits?api_key=${apiKey}`),
          ]);
          const details = await detailsRes.json();
          const credits = await creditsRes.json();

          if (details.backdrop_path) {
            modalBackdrop.style.backgroundImage = `url(${imageBase}w1280${details.backdrop_path})`;
            modalBackdrop.style.backgroundSize = "cover";
            modalBackdrop.style.backgroundPosition = "center";
          } else {
            modalBackdrop.style.backgroundColor = "#f4f4f4";
          }

          if (details.poster_path) {
            modalPoster.src = `${imageBase}w342${details.poster_path}`;
            modalPoster.alt = details.title + " poster";
            modalPoster.style.display = "block";
          }

          modalTitle.textContent =
            details.title +
            (details.release_date
              ? ` (${details.release_date.slice(0, 4)})`
              : "");

          const runtime = details.runtime
            ? `${details.runtime} min`
            : "Runtime unknown";
          const genres =
            details.genres?.map((g) => g.name).join(", ") || "Genres unknown";
          modalInfo.textContent = `${runtime} • ${genres}`;
          modalRating.textContent = `IMDb Rating: ${
            details.vote_average?.toFixed(1) || "N/A"
          }/10`;
          modalOverview.textContent =
            details.overview || "No description available.";

          modalCredits.innerHTML = "";

          const directors = credits.crew.filter((c) => c.job === "Director");
          directors.forEach((director) => {
            const div = document.createElement("div");
            div.className =
              "flex items-center gap-3 flex-shrink-0 max-w-[300px]";

            const img = document.createElement("img");
            img.src = director.profile_path
              ? `${imageBase}w185${director.profile_path}`
              : "https://via.placeholder.com/48?text=No+Photo";
            img.alt = director.name;
            img.className = "w-12 h-12 rounded-full object-cover";

            const name = document.createElement("span");
            name.textContent = director.name;
            name.className = "font-semibold";

            div.appendChild(img);
            div.appendChild(name);
            modalCredits.appendChild(div);
          });

          credits.cast.slice(0, 5).forEach((actor) => {
            const div = document.createElement("div");
            div.className =
              "flex items-center gap-3 flex-shrink-0 max-w-[300px]";

            const img = document.createElement("img");
            img.src = actor.profile_path
              ? `${imageBase}w185${actor.profile_path}`
              : "https://via.placeholder.com/48?text=No+Photo";
            img.alt = actor.name;
            img.className = "w-12 h-12 rounded-full object-cover";

            const name = document.createElement("span");
            name.textContent = `${actor.name} as ${actor.character}`;
            name.className = "font-semibold";

            div.appendChild(img);
            div.appendChild(name);
            modalCredits.appendChild(div);
          });
        } catch (error) {
          modalTitle.textContent = "Error loading movie details";
          modalOverview.textContent =
            "Could not fetch movie details at this time.";
        }
      }

      modalCloseBtn.addEventListener("click", () => {
        modal.classList.add("hidden");
      });

      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.classList.add("hidden");
        }
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const title = input.value.trim();
        const year = yearInput.value.trim();
        if (!title) return;
        errorMsg.textContent = "";

        try {
          let url = `${apiBase}/search/movie?api_key=${apiKey}&query=${encodeURIComponent(
            title
          )}&language=en-US&page=1&include_adult=false`;
          if (year) url += `&year=${year}`;

          const res = await fetch(url);
          const data = await res.json();

          if (!data.results.length) {
            errorMsg.textContent = "No movies found.";
            return;
          }

          let movie = data.results.find(
  (m) =>
    m.title.toLowerCase() === title.toLowerCase() &&
    (!year || (m.release_date && m.release_date.startsWith(year)))
) || data.results[0];

if (savedMovies.some((m) => m.id === movie.id)) {
  errorMsg.textContent = "Movie already added.";
  return;
}

try {
  // Fetch full movie details runtime, rating, etc
  const detailsRes = await fetch(`${apiBase}/movie/${movie.id}?api_key=${apiKey}&language=en-US`);
  const details = await detailsRes.json();

  // Extra data
  movie.runtime = details.runtime;
  movie.vote_average = details.vote_average;
  movie.release_date = details.release_date;

  savedMovies.push(movie);
  saveMovies();
  renderLibrary();

  input.value = "";
  yearInput.value = "";
} catch (err) {
  console.error("Failed to fetch movie details for sorting.", err);
}


          input.value = "";
          yearInput.value = "";
        } catch (error) {
          errorMsg.textContent = "Failed to fetch movie data.";
          console.error(error);
        }
      });

      renderLibrary();
    </script>
    <script>
      const settingsToggle = document.getElementById("settingsToggle");
      const settingsModal = document.getElementById("settingsModal");
      const closeSettings = document.getElementById("closeSettings");

      settingsToggle.addEventListener("click", () => {
        settingsModal.classList.remove("hidden");
      });

      closeSettings.addEventListener("click", () => {
        settingsModal.classList.add("hidden");
      });

      // Export
      document.getElementById("exportBtn").addEventListener("click", () => {
        const data = localStorage.getItem("movieLibrary") || "[]";
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "movie-library.json";
        a.click();
        URL.revokeObjectURL(url);
      });

      // Import
      document.getElementById("importInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
          try {
            const data = JSON.parse(event.target.result);
            if (!Array.isArray(data)) throw new Error("Invalid format");
            localStorage.setItem("movieLibrary", JSON.stringify(data));
            location.reload();
          } catch (err) {
            alert("Failed to import: " + err.message);
          }
        };
        reader.readAsText(file);
      });
    </script>
  </body>
</html>
